// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// AUTHENTICATION & USERS
// =====================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  role      UserRole @default(STAFF)

  // Section assignment for managers
  assignedSection Section?

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  refreshTokens RefreshToken[]
  createdOrders Order[]        @relation("OrderCreator")
  createdProducts Product[]    @relation("ProductCreator")
  updatedProducts Product[]    @relation("ProductUpdater")

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

enum Section {
  CAFE
  FLOWERS
  BOOKS
}

// =====================================================
// PRODUCTS
// =====================================================

model Product {
  id    String  @id @default(uuid())
  sku   String  @unique

  // Basic Information (name for cafe/flowers, title for books)
  name        String?
  title       String?
  description String?  @db.Text
  section     Section

  // Pricing
  price          Decimal @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  costPrice      Decimal? @map("cost_price") @db.Decimal(10, 2)

  // Inventory
  stockQuantity             Int     @default(0) @map("stock_quantity")
  trackQuantity             Boolean @default(true) @map("track_quantity")
  continueSellingOutOfStock Boolean @default(false) @map("continue_selling_out_of_stock")
  availability              ProductAvailability @default(AVAILABLE)

  // Status & Organization
  status      ProductStatus @default(DRAFT)
  tags        String[]
  collections String[]

  // Section-specific attributes (stored as JSON)
  cafeAttributes    Json? @map("cafe_attributes")
  flowersAttributes Json? @map("flowers_attributes")
  booksAttributes   Json? @map("books_attributes")

  // Metadata
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String    @map("created_by")
  updatedBy String?   @map("updated_by")

  // Relations
  creator      User            @relation("ProductCreator", fields: [createdBy], references: [id])
  updater      User?           @relation("ProductUpdater", fields: [updatedBy], references: [id])
  images       ProductImage[]
  variants     ProductVariant[]
  inventory    InventoryItem?
  orderItems   OrderItem[]

  @@index([section])
  @@index([sku])
  @@index([status])
  @@index([availability])
  @@index([createdAt(sort: Desc)])
  @@index([deletedAt])
  @@map("products")
}

model ProductImage {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  originalUrl String   @map("original_url")
  mediumUrl   String   @map("medium_url")
  thumbnailUrl String  @map("thumbnail_url")
  altText     String?  @map("alt_text")
  position    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, position])
  @@index([productId])
  @@map("product_images")
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  title     String
  options   Json
  price     Decimal  @db.Decimal(10, 2)
  sku       String   @unique
  inventory Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

enum ProductStatus {
  ACTIVE
  DRAFT
}

enum ProductAvailability {
  AVAILABLE
  OUT_OF_STOCK
  SEASONAL
  PRE_ORDER
}

// =====================================================
// INVENTORY
// =====================================================

model InventoryItem {
  id          String           @id @default(uuid())
  productId   String           @unique @map("product_id")
  productName String           @map("product_name")
  sku         String
  section     Section
  variant     String?

  // Stock Quantities
  onHand    Int @default(0) @map("on_hand")
  committed Int @default(0)
  available Int @default(0)
  incoming  Int @default(0)

  // Location & Supplier
  location String
  supplier String?

  // Pricing
  costPrice    Decimal @map("cost_price") @db.Decimal(10, 2)
  sellingPrice Decimal @map("selling_price") @db.Decimal(10, 2)

  // Status
  status InventoryStatus @default(IN_STOCK)

  // Reorder Management
  reorderPoint    Int       @default(10) @map("reorder_point")
  reorderQuantity Int       @default(50) @map("reorder_quantity")
  lastRestocked   DateTime? @map("last_restocked")

  // Metadata
  unit    String  @default("units")
  barcode String?

  // Relations
  product     Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  adjustments InventoryAdjustment[]

  @@index([section])
  @@index([status])
  @@index([location])
  @@map("inventory_items")
}

model InventoryAdjustment {
  id          String   @id @default(uuid())
  inventoryId String   @map("inventory_id")
  quantity    Int
  type        AdjustmentType
  reason      String?
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  createdBy   String   @map("created_by")

  inventory InventoryItem @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@map("inventory_adjustments")
}

enum InventoryStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  DISCONTINUED
}

enum AdjustmentType {
  RECEIVED
  SOLD
  DAMAGED
  RETURNED
  TRANSFER
  COUNT
}

// =====================================================
// ORDERS
// =====================================================

model Order {
  id          String   @id @default(uuid())
  orderNumber String   @unique @map("order_number")
  customerId  String   @map("customer_id")
  section     Section

  // Status
  paymentStatus     PaymentStatus     @default(PENDING) @map("payment_status")
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED) @map("fulfillment_status")

  // Pricing
  subtotal     Decimal @db.Decimal(10, 2)
  tax          Decimal @default(0) @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  discount     Decimal @default(0) @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)
  currency     String  @default("PKR")

  // Payment details
  paymentMethod String? @map("payment_method")

  // Metadata
  notes String? @db.Text
  tags  String[]

  // Timestamps
  orderDate DateTime  @default(now()) @map("order_date")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String    @map("created_by")

  // Relations
  customer        Customer         @relation(fields: [customerId], references: [id])
  creator         User             @relation("OrderCreator", fields: [createdBy], references: [id])
  items           OrderItem[]
  shippingAddress ShippingAddress?

  @@index([customerId])
  @@index([section])
  @@index([paymentStatus])
  @@index([fulfillmentStatus])
  @@index([orderDate(sort: Desc)])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")

  // Product details (snapshot at order time)
  productName String  @map("product_name")
  sku         String
  variantId   String? @map("variant_id")

  // Pricing
  price    Decimal @db.Decimal(10, 2)
  quantity Int
  total    Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model ShippingAddress {
  id       String  @id @default(uuid())
  orderId  String  @unique @map("order_id")

  // Address details
  fullName    String  @map("full_name")
  phone       String
  email       String?
  address     String
  city        String
  state       String
  postalCode  String  @map("postal_code")
  country     String  @default("Pakistan")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("shipping_addresses")
}

enum PaymentStatus {
  PAID
  PENDING
  REFUNDED
  FAILED
}

enum FulfillmentStatus {
  FULFILLED
  UNFULFILLED
  PARTIAL
  SCHEDULED
}

// =====================================================
// CUSTOMERS
// =====================================================

model Customer {
  id        String   @id @default(uuid())
  email     String   @unique
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  phone     String?

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Metadata
  tags  String[]
  notes String? @db.Text

  // Statistics
  totalOrders   Int     @default(0) @map("total_orders")
  totalSpent    Decimal @default(0) @map("total_spent") @db.Decimal(10, 2)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orders Order[]

  @@index([email])
  @@map("customers")
}

// =====================================================
// PURCHASE ORDERS
// =====================================================

model PurchaseOrder {
  id             String   @id @default(uuid())
  orderNumber    String   @unique @map("order_number")
  supplierId     String   @map("supplier_id")

  status         PurchaseOrderStatus @default(DRAFT)

  // Pricing
  subtotal       Decimal @db.Decimal(10, 2)
  tax            Decimal @default(0) @db.Decimal(10, 2)
  shippingCost   Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)

  // Dates
  expectedDate   DateTime? @map("expected_date")
  receivedDate   DateTime? @map("received_date")

  // Metadata
  notes          String?   @db.Text

  // Timestamps
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  supplier Supplier           @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]

  @@index([supplierId])
  @@index([status])
  @@index([orderNumber])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String  @id @default(uuid())
  purchaseOrderId String  @map("purchase_order_id")
  productId       String  @map("product_id")

  quantity        Int
  receivedQty     Int     @default(0) @map("received_qty")
  unitCost        Decimal @map("unit_cost") @db.Decimal(10, 2)
  total           Decimal @db.Decimal(10, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

model Supplier {
  id      String  @id @default(uuid())
  name    String
  email   String?
  phone   String?
  address String?

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  ORDERED
  RECEIVING
  RECEIVED
  CANCELLED
}

// =====================================================
// GIFT CARDS
// =====================================================

model GiftCard {
  id              String   @id @default(uuid())
  code            String   @unique
  initialBalance  Decimal  @map("initial_balance") @db.Decimal(10, 2)
  currentBalance  Decimal  @map("current_balance") @db.Decimal(10, 2)

  isActive        Boolean  @default(true) @map("is_active")
  expiresAt       DateTime @map("expires_at")

  // Metadata
  design          String?
  recipientEmail  String?  @map("recipient_email")
  recipientName   String?  @map("recipient_name")
  message         String?  @db.Text

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  transactions GiftCardTransaction[]

  @@index([code])
  @@map("gift_cards")
}

model GiftCardTransaction {
  id         String   @id @default(uuid())
  giftCardId String   @map("gift_card_id")
  amount     Decimal  @db.Decimal(10, 2)
  type       TransactionType
  orderId    String?  @map("order_id")
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)

  @@index([giftCardId])
  @@map("gift_card_transactions")
}

enum TransactionType {
  ISSUED
  USED
  REFUNDED
}

// =====================================================
// DISCOUNTS
// =====================================================

model Discount {
  id          String       @id @default(uuid())
  code        String       @unique
  type        DiscountType
  value       Decimal      @db.Decimal(10, 2)

  // Constraints
  minPurchase Decimal?     @map("min_purchase") @db.Decimal(10, 2)
  maxUsage    Int?         @map("max_usage")
  usageCount  Int          @default(0) @map("usage_count")

  // Applicability
  sections    Section[]
  products    String[]

  // Dates
  startsAt    DateTime     @map("starts_at")
  endsAt      DateTime     @map("ends_at")

  isActive    Boolean      @default(true) @map("is_active")

  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@index([code])
  @@map("discounts")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
  BUY_ONE_GET_ONE
}
