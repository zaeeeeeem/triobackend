// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// AUTHENTICATION & USERS
// =====================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String   @map("first_name")
  lastName  String   @map("last_name")
  role      UserRole @default(STAFF)

  // Section assignment for managers
  assignedSection Section?

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  refreshTokens RefreshToken[]
  createdOrders Order[]        @relation("OrderCreator")
  createdProducts Product[]    @relation("ProductCreator")
  updatedProducts Product[]    @relation("ProductUpdater")

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

enum Section {
  CAFE
  FLOWERS
  BOOKS
}

// =====================================================
// PRODUCTS - Class Table Inheritance
// =====================================================

// Base Product table with common fields
model Product {
  id    String  @id @default(uuid())
  sku   String  @unique
  section Section

  // Pricing
  price          Decimal @db.Decimal(10, 2)
  compareAtPrice Decimal? @map("compare_at_price") @db.Decimal(10, 2)
  costPrice      Decimal? @map("cost_price") @db.Decimal(10, 2)

  // Inventory
  stockQuantity             Int     @default(0) @map("stock_quantity")
  trackQuantity             Boolean @default(true) @map("track_quantity")
  continueSellingOutOfStock Boolean @default(false) @map("continue_selling_out_of_stock")
  availability              ProductAvailability @default(AVAILABLE)

  // Status & Organization
  status      ProductStatus @default(DRAFT)
  tags        String[]
  collections String[]

  // Metadata
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")
  updatedBy String?   @map("updated_by")

  // Relations
  creator      User?           @relation("ProductCreator", fields: [createdBy], references: [id])
  updater      User?           @relation("ProductUpdater", fields: [updatedBy], references: [id])
  images       ProductImage[]
  variants     ProductVariant[]
  inventory    InventoryItem?
  orderItems   OrderItem[]

  // Section-specific relations (one-to-one, mutually exclusive)
  cafeProduct    CafeProduct?
  flowersProduct FlowersProduct?
  booksProduct   BooksProduct?

  @@index([section])
  @@index([sku])
  @@index([status])
  @@index([availability])
  @@index([createdAt(sort: Desc)])
  @@index([deletedAt])
  @@map("products")
}

// Cafe-specific attributes
model CafeProduct {
  id        String  @id @default(uuid())
  productId String  @unique @map("product_id")

  // Cafe product details
  name        String
  description String? @db.Text

  // Cafe-specific attributes
  category        String   // Coffee, Tea, Pastries, etc.
  origin          String?  // Country/region of origin
  roastLevel      String?  @map("roast_level") // Light, Medium, Dark (for coffee)
  caffeineContent String?  @map("caffeine_content") // High, Medium, Low, None
  size            String?  // Small, Medium, Large
  temperature     String?  // Hot, Iced, Cold Brew
  allergens       String[] // Dairy, Nuts, Gluten, etc.
  calories        Int?

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([category])
  @@map("cafe_products")
}

// Flowers-specific attributes
model FlowersProduct {
  id        String  @id @default(uuid())
  productId String  @unique @map("product_id")

  // Flowers product details
  name        String
  description String? @db.Text

  // Flowers-specific attributes
  arrangementType  String   @map("arrangement_type") // Bouquet, Vase, Basket, etc.
  occasion         String?  // Wedding, Birthday, Sympathy, etc.
  colors           String[] // Red, White, Pink, etc.
  flowerTypes      String[] @map("flower_types") // Rose, Lily, Tulip, etc.
  size             String?  // Small, Medium, Large, Premium
  seasonality      String?  // Year-round, Spring, Summer, etc.
  careInstructions String?  @map("care_instructions") @db.Text
  vaseIncluded     Boolean  @default(false) @map("vase_included")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([arrangementType])
  @@map("flowers_products")
}

// Books-specific attributes
model BooksProduct {
  id        String  @id @default(uuid())
  productId String  @unique @map("product_id")

  // Books product details
  title       String
  description String? @db.Text

  // Books-specific attributes
  author      String
  isbn        String?   @unique
  publisher   String?
  publishDate DateTime? @map("publish_date")
  language    String    @default("English")
  pageCount   Int?      @map("page_count")
  format      String    // Hardcover, Paperback, eBook
  genre       String[]  // Fiction, Non-Fiction, Biography, etc. (can have multiple genres)
  condition   String    @default("New") // New, Like New, Good, Fair
  edition     String?
  dimensions  String?   // e.g., "8.5 x 11 x 1 inches"
  weight      Int?      // in grams

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([author])
  @@index([isbn])
  @@index([genre])
  @@map("books_products")
}

model ProductImage {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  originalUrl String   @map("original_url")
  mediumUrl   String   @map("medium_url")
  thumbnailUrl String  @map("thumbnail_url")
  altText     String?  @map("alt_text")
  position    Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, position])
  @@index([productId])
  @@map("product_images")
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  title     String
  options   Json
  price     Decimal  @db.Decimal(10, 2)
  sku       String   @unique
  inventory Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

enum ProductStatus {
  ACTIVE
  DRAFT
}

enum ProductAvailability {
  AVAILABLE
  OUT_OF_STOCK
  SEASONAL
  PRE_ORDER
}

// =====================================================
// INVENTORY
// =====================================================

model InventoryItem {
  id          String           @id @default(uuid())
  productId   String           @unique @map("product_id")
  productName String           @map("product_name")
  sku         String
  section     Section
  variant     String?

  // Stock Quantities
  onHand    Int @default(0) @map("on_hand")
  committed Int @default(0)
  available Int @default(0)
  incoming  Int @default(0)

  // Location & Supplier
  location String
  supplier String?

  // Pricing
  costPrice    Decimal @map("cost_price") @db.Decimal(10, 2)
  sellingPrice Decimal @map("selling_price") @db.Decimal(10, 2)

  // Status
  status InventoryStatus @default(IN_STOCK)

  // Reorder Management
  reorderPoint    Int       @default(10) @map("reorder_point")
  reorderQuantity Int       @default(50) @map("reorder_quantity")
  lastRestocked   DateTime? @map("last_restocked")

  // Metadata
  unit    String  @default("units")
  barcode String?

  // Relations
  product     Product                @relation(fields: [productId], references: [id], onDelete: Cascade)
  adjustments InventoryAdjustment[]

  @@index([section])
  @@index([status])
  @@index([location])
  @@map("inventory_items")
}

model InventoryAdjustment {
  id          String   @id @default(uuid())
  inventoryId String   @map("inventory_id")
  quantity    Int
  type        AdjustmentType
  reason      String?
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  createdBy   String   @map("created_by")

  inventory InventoryItem @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([inventoryId])
  @@map("inventory_adjustments")
}

enum InventoryStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  DISCONTINUED
}

enum AdjustmentType {
  RECEIVED
  SOLD
  DAMAGED
  RETURNED
  TRANSFER
  COUNT
}

// =====================================================
// ORDERS
// =====================================================

model Order {
  id          String   @id @default(uuid())
  orderNumber String   @unique @map("order_number")

  // Customer Link (NULL for guest orders)
  customerId  String?  @map("customer_id")

  // Always Store Email (for guest linking & identification)
  customerEmail String  @map("customer_email")
  customerName  String  @map("customer_name")
  customerPhone String? @map("customer_phone")

  // Guest Tracking
  guestOrder Boolean @default(false) @map("guest_order")
  guestToken String? @map("guest_token") // Temporary guest session token

  section     Section

  // Status
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  orderStatus   OrderStatus   @default(PENDING) @map("order_status")

  // Pricing
  subtotal     Decimal @db.Decimal(10, 2)
  tax          Decimal @default(0) @db.Decimal(10, 2)
  shippingCost Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  discount     Decimal @default(0) @db.Decimal(10, 2)
  total        Decimal @db.Decimal(10, 2)
  currency     String  @default("PKR")

  // Payment details
  paymentMethod String? @map("payment_method")

  // Metadata
  notes String? @db.Text
  tags  String[]

  // Timestamps
  orderDate DateTime  @default(now()) @map("order_date")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  createdBy String?   @map("created_by")

  // Relations
  customer        Customer?        @relation(fields: [customerId], references: [id])
  creator         User?            @relation("OrderCreator", fields: [createdBy], references: [id])
  items           OrderItem[]
  shippingAddress ShippingAddress?

  @@index([customerId])
  @@index([customerEmail]) // Index for guest order lookup
  @@index([section])
  @@index([paymentStatus])
  @@index([orderStatus])
  @@index([orderDate(sort: Desc)])
  @@index([orderNumber])
  @@index([guestToken])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")

  // Product details (snapshot at order time)
  productName String  @map("product_name")
  sku         String
  variantId   String? @map("variant_id")

  // Pricing
  price    Decimal @db.Decimal(10, 2)
  quantity Int
  total    Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model ShippingAddress {
  id       String  @id @default(uuid())
  orderId  String  @unique @map("order_id")

  // Address details
  fullName    String  @map("full_name")
  phone       String
  email       String?
  address     String
  city        String
  state       String
  postalCode  String  @map("postal_code")
  country     String  @default("Pakistan")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("shipping_addresses")
}

enum PaymentStatus {
  PAID
  PENDING
  REFUNDED
  FAILED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

// =====================================================
// CUSTOMERS
// =====================================================

model Customer {
  id        String   @id @default(uuid())
  email     String   @unique

  // Authentication
  passwordHash              String?  @map("password_hash") // NULL for guest-converted customers
  emailVerified             Boolean  @default(false) @map("email_verified")
  emailVerificationToken    String?  @map("email_verification_token")
  emailVerificationExpiry   DateTime? @map("email_verification_expiry")
  passwordResetToken        String?  @map("password_reset_token")
  passwordResetExpiry       DateTime? @map("password_reset_expiry")

  // Basic Information
  name      String   // Full name (required)
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  phone     String?

  // Location
  location String? // City, Country
  timezone String? @default("Asia/Karachi")
  language String? @default("en")

  // Status & Metrics
  status            CustomerStatus @default(ACTIVE)
  totalOrders       Int     @default(0) @map("total_orders") // Total order count
  totalSpent        Decimal @default(0) @map("total_spent") @db.Decimal(10, 2)
  averageOrderValue Decimal @default(0) @map("average_order_value") @db.Decimal(10, 2)

  // Segmentation
  tags         String[]
  customerType CustomerType? @map("customer_type")

  // Preferences
  marketingConsent  Boolean @default(false) @map("marketing_consent")
  smsConsent        Boolean @default(false) @map("sms_consent")
  emailPreferences  Json    @default("{\"newsletter\": true, \"orderUpdates\": true, \"promotions\": false}") @map("email_preferences")

  // Account Origin
  createdFromGuest     Boolean @default(false) @map("created_from_guest")
  registrationSource   String? @map("registration_source") // web, mobile, admin, guest_conversion

  // Metadata
  notes          String?   @db.Text
  lastLogin      DateTime? @map("last_login")
  lastOrderDate  DateTime? @map("last_order_date")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at") // Soft delete

  // Relations
  orders          Order[]
  addresses       CustomerAddress[]
  refreshTokens   CustomerRefreshToken[]

  @@index([email])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([deletedAt])
  @@map("customers")
}

enum CustomerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CustomerType {
  RETAIL
  WHOLESALE
  CORPORATE
}

// Customer Address model
model CustomerAddress {
  id         String  @id @default(uuid())
  customerId String  @map("customer_id")

  // Address Details
  firstName    String  @map("first_name")
  lastName     String  @map("last_name")
  company      String?
  addressLine1 String  @map("address_line1")
  addressLine2 String? @map("address_line2")
  city         String
  state        String? // State/Province
  postalCode   String  @map("postal_code")
  country      String  // ISO country code

  // Contact
  phone String?

  // Flags
  isDefault        Boolean @default(false) @map("is_default")
  isDefaultBilling Boolean @default(false) @map("is_default_billing")

  // Metadata
  label     String?   // "Home", "Office", etc.
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([customerId, isDefault])
  @@map("customer_addresses")
}

// Customer Refresh Tokens (separate from admin User refresh tokens)
model CustomerRefreshToken {
  id         String   @id @default(uuid())
  customerId String   @map("customer_id")
  token      String   @unique
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([token])
  @@map("customer_refresh_tokens")
}

// =====================================================
// PURCHASE ORDERS
// =====================================================

model PurchaseOrder {
  id             String   @id @default(uuid())
  orderNumber    String   @unique @map("order_number")
  supplierId     String   @map("supplier_id")

  status         PurchaseOrderStatus @default(DRAFT)

  // Pricing
  subtotal       Decimal @db.Decimal(10, 2)
  tax            Decimal @default(0) @db.Decimal(10, 2)
  shippingCost   Decimal @default(0) @map("shipping_cost") @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)

  // Dates
  expectedDate   DateTime? @map("expected_date")
  receivedDate   DateTime? @map("received_date")

  // Metadata
  notes          String?   @db.Text

  // Timestamps
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  supplier Supplier           @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]

  @@index([supplierId])
  @@index([status])
  @@index([orderNumber])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String  @id @default(uuid())
  purchaseOrderId String  @map("purchase_order_id")
  productId       String  @map("product_id")

  quantity        Int
  receivedQty     Int     @default(0) @map("received_qty")
  unitCost        Decimal @map("unit_cost") @db.Decimal(10, 2)
  total           Decimal @db.Decimal(10, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}

model Supplier {
  id      String  @id @default(uuid())
  name    String
  email   String?
  phone   String?
  address String?

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  ORDERED
  RECEIVING
  RECEIVED
  CANCELLED
}

// =====================================================
// GIFT CARDS
// =====================================================

model GiftCard {
  id              String   @id @default(uuid())
  code            String   @unique
  initialBalance  Decimal  @map("initial_balance") @db.Decimal(10, 2)
  currentBalance  Decimal  @map("current_balance") @db.Decimal(10, 2)

  isActive        Boolean  @default(true) @map("is_active")
  expiresAt       DateTime @map("expires_at")

  // Metadata
  design          String?
  recipientEmail  String?  @map("recipient_email")
  recipientName   String?  @map("recipient_name")
  message         String?  @db.Text

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  transactions GiftCardTransaction[]

  @@index([code])
  @@map("gift_cards")
}

model GiftCardTransaction {
  id         String   @id @default(uuid())
  giftCardId String   @map("gift_card_id")
  amount     Decimal  @db.Decimal(10, 2)
  type       TransactionType
  orderId    String?  @map("order_id")
  notes      String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)

  @@index([giftCardId])
  @@map("gift_card_transactions")
}

enum TransactionType {
  ISSUED
  USED
  REFUNDED
}

// =====================================================
// DISCOUNTS
// =====================================================

model Discount {
  id          String       @id @default(uuid())
  code        String       @unique
  type        DiscountType
  value       Decimal      @db.Decimal(10, 2)

  // Constraints
  minPurchase Decimal?     @map("min_purchase") @db.Decimal(10, 2)
  maxUsage    Int?         @map("max_usage")
  usageCount  Int          @default(0) @map("usage_count")

  // Applicability
  sections    Section[]
  products    String[]

  // Dates
  startsAt    DateTime     @map("starts_at")
  endsAt      DateTime     @map("ends_at")

  isActive    Boolean      @default(true) @map("is_active")

  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@index([code])
  @@map("discounts")
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
  BUY_ONE_GET_ONE
}
